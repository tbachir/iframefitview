<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>HuddleBoard Display</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div id="app"></div>

    <!-- Configuration -->
    <script src="../config.js"></script>
    
    <!-- Modules HuddleBoard -->
    <script src="js/health-monitor.js"></script>
    <script src="js/scale-handler.js"></script>
    <script src="js/refresh-service.js"></script>
    <script src="js/display-manager.js"></script>
    
    <!-- Application principale -->
    <script>
        /**
         * Core Application - Point d'entr√©e principal
         */
        class Core {
            constructor() {
                this.display = null;
                this.displayManager = null;
                this.healthMonitor = null;
            }

            /**
             * Initialise l'application
             */
            init() {
                console.log('üöÄ Initialisation HuddleBoard Display');
                
                // Initialiser le monitoring de sant√©
                this.initHealthMonitoring();
                
                // Valider et charger la configuration
                if (!this.validateConfig()) {
                    this.showConfigError();
                    return;
                }
                
                // Trouver et charger le display
                if (!this.loadDisplay()) {
                    this.showDisplayError();
                    return;
                }
                
                // Initialiser le gestionnaire d'affichage
                this.initDisplayManager();
                
                console.log('‚úÖ HuddleBoard Display initialis√© avec succ√®s');
            }

            /**
             * Initialise le monitoring de sant√©
             */
            initHealthMonitoring() {
                this.healthMonitor = new HealthMonitor();
                const monitoringEnabled = this.healthMonitor.init();
                
                // Rendre le monitor accessible globalement
                window.healthMonitor = this.healthMonitor;
                
                console.log(`${monitoringEnabled ? 'üîç' : 'üì¥'} Monitoring: ${monitoringEnabled ? 'Activ√©' : 'D√©sactiv√©'}`);
            }

            /**
             * Valide la configuration globale
             */
            validateConfig() {
                if (!window.AppConfig) {
                    console.error('‚ùå window.AppConfig non trouv√©');
                    return false;
                }
                
                if (!window.AppConfig.displays || !Array.isArray(window.AppConfig.displays)) {
                    console.error('‚ùå AppConfig.displays manquant ou invalide');
                    return false;
                }
                
                if (window.AppConfig.displays.length === 0) {
                    console.error('‚ùå Aucun display configur√©');
                    return false;
                }
                
                return true;
            }

            /**
             * Charge le display bas√© sur l'URL
             */
            loadDisplay() {
                const hash = window.location.hash;
                const slug = hash?.startsWith('#/') ? hash.substring(2) : null;
                
                if (!slug) {
                    console.error('‚ùå Slug manquant dans l\'URL');
                    return false;
                }
                
                this.display = window.AppConfig.displays.find(d => d?.slug === slug);
                
                if (!this.display) {
                    console.error(`‚ùå Display '${slug}' non trouv√©`);
                    return false;
                }
                
                console.log(`üì∫ Display charg√©: ${this.display.name} (${this.display.slug})`);
                return true;
            }

            /**
             * Initialise le gestionnaire d'affichage
             */
            initDisplayManager() {
                this.displayManager = new DisplayManager(this.display);
                this.displayManager.render();
            }

            /**
             * Affiche une erreur de configuration
             */
            showConfigError() {
                document.getElementById('app').innerHTML = `
                    <div style="padding: 50px; text-align: center; font-family: Arial; color: #dc2626;">
                        <h2>‚ùå Configuration manquante</h2>
                        <p>Le fichier config.js est manquant ou invalide</p>
                        <a href="../" style="color: #dc2626; text-decoration: none;">‚Üê Retour √† l'accueil</a>
                    </div>
                `;
            }

            /**
             * Affiche une erreur de display
             */
            showDisplayError() {
                const hash = window.location.hash?.substring(2) || 'unknown';
                document.getElementById('app').innerHTML = `
                    <div style="padding: 50px; text-align: center; font-family: Arial; color: #dc2626;">
                        <h2>‚ùå Display non trouv√©</h2>
                        <p>Le display '${hash}' n'existe pas dans la configuration</p>
                        <a href="../" style="color: #dc2626; text-decoration: none;">‚Üê Retour √† l'accueil</a>
                    </div>
                `;
            }

            /**
             * Nettoie les ressources avant fermeture
             */
            cleanup() {
                console.log('üßπ Nettoyage Core Application');
                
                if (this.displayManager) {
                    this.displayManager.cleanup();
                    this.displayManager = null;
                }
                
                if (this.healthMonitor) {
                    this.healthMonitor.cleanup();
                    this.healthMonitor = null;
                    window.healthMonitor = null;
                }
                
                this.display = null;
            }

            /**
             * R√©cup√®re les informations de l'application
             */
            getAppInfo() {
                return {
                    display: this.display ? {
                        name: this.display.name,
                        slug: this.display.slug,
                        path: this.display.path,
                        monitoring: this.display.monitoring
                    } : null,
                    healthMonitoring: this.healthMonitor ? this.healthMonitor.getStats() : null,
                    displayManager: this.displayManager ? this.displayManager.getDisplayInfo() : null
                };
            }
        }

        /**
         * Fonctions utilitaires globales
         */

        function getOrCreateBanner(id, classes) {
            let el = document.getElementById(id);
            if (!el) {
                el = document.createElement('div');
                el.id = id;
                el.className = classes;
                document.body.appendChild(el);
            }
            return el;
        }

        function formatTime(date) {
            return date
                ? date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                : '‚Äî';
        }

        function showModifBanner(date = new Date()) {
            getOrCreateBanner('modif-banner', 'banner modif-banner').textContent =
                `Last synced edition ${formatTime(date)}`;
        }

        function showStatusBanner(date, ok = true) {
            showStatusBanner.lastDate = ok && date ? date : showStatusBanner.lastDate;
            const el = getOrCreateBanner('status-banner', 'banner status-banner');
            el.innerHTML = `<span class="status-indicator${ok ? '' : ' status-fail'}"></span><span>${formatTime(showStatusBanner.lastDate)}</span>`;
        }

        // Rendre les fonctions accessibles globalement
        window.getOrCreateBanner = getOrCreateBanner;
        window.formatTime = formatTime;
        window.showModifBanner = showModifBanner;
        window.showStatusBanner = showStatusBanner;

        /**
         * Initialisation et gestion du cycle de vie
         */

        // Instance globale de l'application
        const app = new Core();

        // Nettoyage avant d√©chargement de la page
        window.addEventListener('beforeunload', () => {
            app.cleanup();
        });

        // Gestion des changements de hash (navigation)
        window.addEventListener('hashchange', () => {
            console.log('üîÑ Changement de hash d√©tect√©, rechargement...');
            app.cleanup();
            setTimeout(() => app.init(), 100);
        });

        // Initialisation au chargement de la page
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => app.init());
        } else {
            app.init();
        }

        // Exposer l'application pour le debug
        window.HuddleBoardApp = app;
        
        // Commandes de debug utiles
        window.debug = {
            getAppInfo: () => app.getAppInfo(),
            forceRefresh: () => app.displayManager?.forceRefresh(),
            getHealthStats: () => window.healthMonitor?.getStats(),
            getScaleInfo: () => app.displayManager?.scaleHandler?.getScaleInfo(),
            getRefreshStats: () => app.displayManager?.refreshService?.getStats(),
            setFillMode: (mode) => app.displayManager?.scaleHandler?.setFillMode(mode)
        };

        console.log('üõ†Ô∏è Commandes debug disponibles: window.debug');
    </script>
</body>
</html>