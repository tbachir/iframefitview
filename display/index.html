<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>HuddleBoard Display</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div id="app"></div>

    <!-- Configuration -->
    <script src="../config.js"></script>

    <!-- Modules HuddleBoard -->
    <script src="health-monitor/health-monitor.js"></script>
    <script src="js/scale-handler.js"></script>
    <script src="js/refresh-service.js"></script>
    <script src="js/display-manager.js"></script>

    <!-- Application principale -->
    <script>
        /**
         * Core Application - Point d'entr√©e principal
         */
        class Core {
            constructor() {
                this.display = null;
                this.displayManager = null;
            }

            /**
             * Initialise l'application
             */
            init() {
                console.log('üöÄ Initialisation HuddleBoard Display');

                // Valider et charger la configuration
                if (!this.validateConfig()) {
                    this.showConfigError();
                    return;
                }

                // Trouver et charger le display
                if (!this.loadDisplay()) {
                    this.showDisplayError();
                    return;
                }

                // Restaurer la derni√®re date de modification
                this.restoreLastSync();

                // Initialiser le gestionnaire d'affichage
                this.initDisplayManager();

                console.log('‚úÖ HuddleBoard Display initialis√© avec succ√®s');
            }

            /**
             * Valide la configuration globale
             */
            validateConfig() {
                if (!window.AppConfig) {
                    console.error('‚ùå window.AppConfig non trouv√©');
                    return false;
                }

                if (!window.AppConfig.displays || !Array.isArray(window.AppConfig.displays)) {
                    console.error('‚ùå AppConfig.displays manquant ou invalide');
                    return false;
                }

                if (window.AppConfig.displays.length === 0) {
                    console.error('‚ùå Aucun display configur√©');
                    return false;
                }

                return true;
            }

            /**
             * Charge le display bas√© sur l'URL
             */
            loadDisplay() {
                const hash = window.location.hash;
                const slug = hash?.startsWith('#/') ? hash.substring(2) : null;

                if (!slug) {
                    console.error('‚ùå Slug manquant dans l\'URL');
                    return false;
                }

                this.display = window.AppConfig.displays.find(d => d?.slug === slug);

                if (!this.display) {
                    console.error(`‚ùå Display '${slug}' non trouv√©`);
                    return false;
                }

                console.log(`üì∫ Display charg√©: ${this.display.name} (${this.display.slug})`);
                return true;
            }

            /**
             * Restaure la derni√®re date de synchronisation
             */
            restoreLastSync() {
                try {
                    const lastSync = localStorage.getItem('hb_sync');
                    if (lastSync) {
                        const syncDate = new Date(parseInt(lastSync));
                        console.log('üìÖ Derni√®re sync restaur√©e:', syncDate.toLocaleString());
                        showModifBanner(syncDate);
                    }
                } catch (e) {
                    console.warn('Erreur lors de la restauration de la derni√®re sync:', e);
                }
            }

            /**
             * Initialise le gestionnaire d'affichage
             */
            initDisplayManager() {
                this.displayManager = new DisplayManager(this.display);
                this.displayManager.render();
            }

            /**
             * Affiche une erreur de configuration
             */
            showConfigError() {
                document.getElementById('app').innerHTML = `
                    <div style="padding: 50px; text-align: center; font-family: Arial; color: #dc2626;">
                        <h2>‚ùå Configuration manquante</h2>
                        <p>Le fichier config.js est manquant ou invalide</p>
                        <a href="../" style="color: #dc2626; text-decoration: none;">‚Üê Retour √† l'accueil</a>
                    </div>
                `;
            }

            /**
             * Affiche une erreur de display
             */
            showDisplayError() {
                const hash = window.location.hash?.substring(2) || 'unknown';
                document.getElementById('app').innerHTML = `
                    <div style="padding: 50px; text-align: center; font-family: Arial; color: #dc2626;">
                        <h2>‚ùå Display non trouv√©</h2>
                        <p>Le display '${hash}' n'existe pas dans la configuration</p>
                        <a href="../" style="color: #dc2626; text-decoration: none;">‚Üê Retour √† l'accueil</a>
                    </div>
                `;
            }

            /**
             * Nettoie les ressources avant fermeture - VERSION AM√âLIOR√âE
             */
            cleanup() {
                console.log('üßπ Nettoyage Core Application');

                // Nettoyer les banners et leurs timers
                if (typeof window.cleanupBanners === 'function') {
                    window.cleanupBanners();
                }

                if (this.displayManager) {
                    this.displayManager.cleanup();
                    this.displayManager = null;
                }

                this.display = null;
            }

            /**
             * R√©cup√®re les informations de l'application
             */
            async getAppInfo() {
                return {
                    display: this.display ? {
                        name: this.display.name,
                        slug: this.display.slug,
                        path: this.display.path
                    } : null,
                };
            }

            /**
             * Calcule le temps √©coul√© depuis une date
             */
            getTimeAgo(date) {
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);

                if (diffMins < 1) return '√† l\'instant';
                if (diffMins < 60) return `il y a ${diffMins}min`;

                const diffHours = Math.floor(diffMins / 60);
                if (diffHours < 24) return `il y a ${diffHours}h`;

                const diffDays = Math.floor(diffHours / 24);
                return `il y a ${diffDays}j`;
            }
        }

        /**
         * Fonctions utilitaires globales
         */

        let modifBannerTimer = null;

        function getOrCreateBanner(id, classes) {
            let el = document.getElementById(id);
            if (!el) {
                el = document.createElement('div');
                el.id = id;
                el.className = classes;
                document.body.appendChild(el);
            }
            return el;
        }

        function formatTime(date) {
            return date
                ? date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                : '‚Äî';
        }

        function showModifBanner(date = new Date()) {
            const el = getOrCreateBanner('modif-banner', 'banner modif-banner bottom-right');

            // Sauvegarder la nouvelle date de modification SEULEMENT si c'est une vraie modification
            if (date && date !== showModifBanner.defaultDate) {
                try {
                    localStorage.setItem('hb_sync', date.getTime());
                } catch (e) {
                    console.warn('Impossible de sauvegarder la date de sync:', e);
                }
            }

            // Nettoyer le timer existant pour √©viter les doublons
            if (modifBannerTimer) {
                clearInterval(modifBannerTimer);
                modifBannerTimer = null;
            }

            function updateTime() {
                try {
                    const lastSync = localStorage.getItem('hb_sync');
                    // Utiliser la date sauvegard√©e en priorit√©
                    const syncDate = lastSync ? new Date(parseInt(lastSync)) : date;
                    const timeAgo = getTimeAgo(syncDate);

                    el.innerHTML = `
                <svg class="modif-icon" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
                </svg>
                <div class="modif-text">
                    <div class="modif-primary">Synchronis√©</div>
                    <div class="modif-time">${timeAgo}</div>
                </div>
            `;
                } catch (e) {
                    console.warn('Erreur lors de la mise √† jour du banner:', e);
                }
            }

            // Mise √† jour imm√©diate
            updateTime();

            // Programmer les mises √† jour futures
            modifBannerTimer = setInterval(updateTime, 60000); // Mise √† jour chaque minute
        }
        // Marquer la date par d√©faut pour √©viter de sauvegarder les appels automatiques
        showModifBanner.defaultDate = new Date();

        function showStatusBanner(date, ok = true, errorCount = 0) {
            showStatusBanner.lastDate = ok && date ? date : showStatusBanner.lastDate;
            const el = getOrCreateBanner('status-banner', 'banner status-banner bottom-left');

            let statusClass, statusText, secondaryText;

            if (!ok) {
                statusClass = 'status-fail';
                statusText = 'Hors ligne';
                secondaryText = 'Reconnexion...';
            } else if (errorCount > 5) {
                statusClass = 'status-warning';
                statusText = 'Instable';
                secondaryText = `${errorCount} erreurs`;
            } else {
                statusClass = 'status-online';
                statusText = 'En ligne';
                secondaryText = formatTime(showStatusBanner.lastDate);
            }

            el.innerHTML = `
                <div class="status-indicator ${statusClass}"></div>
                <div class="status-text">
                    <div class="status-primary">${statusText}</div>
                    <div class="status-secondary">${secondaryText}</div>
                </div>
            `;
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);

            if (diffMins < 1) return '√† l\'instant';
            if (diffMins < 60) return `il y a ${diffMins}min`;

            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `il y a ${diffHours}h`;

            const diffDays = Math.floor(diffHours / 24);
            return `il y a ${diffDays}j`;
        }

        function showLoadingBanner(message = 'Chargement...') {
            const el = getOrCreateBanner('loading-banner', 'banner loading-banner bottom-right');
            el.innerHTML = `
                <div class="loading-spinner"></div>
                <span>${message}</span>
            `;
        }

        function showErrorBanner(message, duration = 5000) {
            const el = getOrCreateBanner('error-banner', 'banner error-banner bottom-right');
            el.innerHTML = `
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
                <span>${message}</span>
            `;

            if (duration > 0) {
                setTimeout(() => {
                    el.remove();
                }, duration);
            }
        }

        function showWarningBanner(message, duration = 5000) {
            const el = getOrCreateBanner('warning-banner', 'banner warning-banner bottom-right');
            el.innerHTML = `
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
                <span>${message}</span>
            `;

            if (duration > 0) {
                setTimeout(() => {
                    el.remove();
                }, duration);
            }
        }

        function hideLoadingBanner() {
            const el = document.getElementById('loading-banner');
            if (el) el.remove();
        }

        // Fonction de nettoyage pour √©viter les fuites m√©moire
        function cleanupBanners() {
            if (modifBannerTimer) {
                clearInterval(modifBannerTimer);
                modifBannerTimer = null;
            }
        }

        // Rendre les fonctions accessibles globalement
        window.getOrCreateBanner = getOrCreateBanner;
        window.formatTime = formatTime;
        window.showModifBanner = showModifBanner;
        window.showStatusBanner = showStatusBanner;
        window.cleanupBanners = cleanupBanners;

        /**
         * Initialisation et gestion du cycle de vie
         */

        // Instance globale de l'application
        const app = new Core();

        // Nettoyage avant d√©chargement de la page
        window.addEventListener('beforeunload', () => {
            app.cleanup();
        });

        // Gestion des changements de hash (navigation)
        window.addEventListener('hashchange', () => {
            console.log('üîÑ Changement de hash d√©tect√©, rechargement...');
            app.cleanup();
            setTimeout(() => app.init(), 100);
        });

        // Initialisation au chargement de la page
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => app.init());
        } else {
            app.init();
        }

        window.HuddleBoardApp = app;

    </script>
</body>

</html>