<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>HuddleBoard Display</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }

        .display-header {
            position: fixed;
            top: 0;
            left: 0;
            padding: 10px 15px;
            z-index: 1000;
            display: flex;
            align-items: center;
            background: #dc2626;
            color: white;
            text-transform: uppercase;
        }

        .back-button {
            border: none;
            background: none;
            color: white;
            padding: 0.5rem;
            cursor: pointer;
            font-size: 1.5rem;
            text-decoration: none;
            margin-right: 10px;
        }

        .iframe-container {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 100vw;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .iframe-container iframe {
            border: none;
            background: transparent;
            transform-origin: 0 0;
        }
    </style>
</head>
<body>
    <div id="app"></div>
    
    <script src="../config.js"></script>
    <script>
        class Core {
            constructor() {
                this.display = null;
            }

            getSlugFromHash() {
                const hash = window.location.hash;
                return hash?.startsWith('#/') ? hash.substring(2) : null;
            }

            findDisplayBySlug(slug) {
                const displays = window.AppConfig?.displays || [];
                return displays.find(d => d?.slug === slug);
            }

            init() {
                // Validation config minimale
                if (!window.AppConfig?.displays) {
                    document.getElementById('app').innerHTML = `
                        <div style="padding: 50px; text-align: center; font-family: Arial;">
                            <h2>Configuration manquante</h2>
                            <a href="../" style="color: #dc2626;">← Retour</a>
                        </div>
                    `;
                    return;
                }

                const slug = this.getSlugFromHash();
                this.display = this.findDisplayBySlug(slug);
                
                if (this.display) {
                    const displayManager = new DisplayManager(this.display);
                    displayManager.render();
                }
            }
        }

        class DisplayManager {
            constructor(display) {
                this.display = display;
                this.iframe = null;
            }

            render() {
                document.getElementById('app').innerHTML = `
                    <div class="display-header">
                        <a href="../" class="back-button">←</a>
                        <h3 style="margin: 0;">${this.display.name}</h3>
                    </div>
                    <div class="iframe-container">
                        <iframe src="${this.display.path}" id="display-iframe"></iframe>
                    </div>
                `;
                
                this.iframe = document.getElementById('display-iframe');
                
                // Initialiser les services
                new ScaleHandler(this.iframe);
                new RefreshService(this.display, this.iframe);
            }
        }

        class ScaleHandler {
            constructor(iframe) {
                this.iframe = iframe;
                this.contentW = window.innerWidth;
                this.contentH = window.innerHeight;

                this.init();
            }

            init() {
                this.iframe.addEventListener('load', () => {
                    setTimeout(() => this.onLoad(), 150);
                });
                window.addEventListener('resize', () => this.applyScale());
            }

            onLoad() {
                const doc = this.iframe.contentDocument;
                if (!doc) return;

                // Masquer les scrollbars et mesurer le contenu
                doc.head.appendChild(Object.assign(doc.createElement('style'), {
                    textContent: 'html, body { overflow: hidden !important; margin: 0; padding: 0; }'
                }));

                this.contentW = Math.max(
                    doc.documentElement.scrollWidth,
                    doc.documentElement.offsetWidth,
                    doc.body.scrollWidth,
                    doc.body.offsetWidth,
                    1
                );
                
                this.contentH = Math.max(
                    doc.documentElement.scrollHeight,
                    doc.documentElement.offsetHeight,
                    doc.body.scrollHeight,
                    doc.body.offsetHeight,
                    1
                );

                this.applyScale();
            }

            applyScale() {
                const containerW = window.innerWidth;
                const containerH = window.innerHeight;
                const scale = Math.min(containerW / this.contentW, containerH / this.contentH);

                Object.assign(this.iframe.style, {
                    width: `${this.contentW}px`,
                    height: `${this.contentH}px`,
                    transform: `scale(${scale})`,
                    left: `${(containerW - this.contentW * scale) / 2}px`,
                    top: `${(containerH - this.contentH * scale) / 2}px`,
                    position: 'absolute'
                });
            }
        }

        class RefreshService {
            constructor(display, iframe) {
                this.display = display;
                this.iframe = iframe;
                this.interval = display.refreshInterval || window.AppConfig?.defaultRefreshInterval || 30000;
                this.timer = null;
                this.lastContent = null;

                this.start();
            }

            start() {
                this.timer = setInterval(() => this.refresh(), this.interval);
            }

            async refresh() {
                const preloadUrl = this.buildUrl();
                
                // Vérifier d'abord le status HTTP
                const isValidResponse = await this.checkHttpStatus(preloadUrl);
                if (!isValidResponse) {
                    console.warn('HTTP error detected, skipping refresh');
                    return;
                }
                
                const preloader = new PreloadService(preloadUrl);
                
                preloader.onLoad((iframe) => {
                    const newContent = this.getIframeContent(iframe);
                    
                    if (!newContent) {
                        preloader.destroy();
                        return;
                    }
                    
                    // Premier chargement : juste initialiser
                    if (!this.lastContent) {
                        this.lastContent = newContent;
                        preloader.destroy();
                        return;
                    }
                    
                    // Changement détecté : utiliser la même URL que le preload
                    if (newContent !== this.lastContent) {
                        this.lastContent = newContent;
                        this.iframe.src = preloadUrl;
                    }
                    
                    preloader.destroy();
                });

                preloader.onError(() => {
                    console.warn('Preloader error detected');
                    preloader.destroy();
                });
            }

            async checkHttpStatus(url) {
                try {
                    const response = await fetch(url, { 
                        method: 'GET',
                        cache: 'no-cache'
                    });
                    return response.ok;
                } catch (error) {
                    console.warn('Fetch error:', error.message);
                    return false;
                }
            }

            buildUrl() {
                const base = this.display.path;
                const separator = base.includes('?') ? '&' : '?';
                return `${base}${separator}t=${Date.now()}`;
            }

            getIframeContent(iframe) {
                const doc = iframe.contentDocument || iframe.contentWindow.document;
                return doc?.documentElement.innerHTML || null;
            }
        }

        class PreloadService {
            constructor(url, timeout = 10000) {
                this.timeout = timeout;
                this.iframe = null;
                this.timeoutId = null;
                this.onLoadCallback = null;
                this.onErrorCallback = null;

                this.init(url);
            }

            init(url) {
                this.iframe = document.createElement('iframe');
                this.iframe.style.display = 'none';
                document.body.appendChild(this.iframe);

                this.iframe.addEventListener('load', () => this.handleLoad());
                this.iframe.addEventListener('error', (error) => this.handleError(error));

                this.timeoutId = setTimeout(() => this.handleError(new Error('Loading timeout')), this.timeout);
                this.iframe.src = url;
            }

            handleLoad() {
                this.clearTimeout();
                this.onLoadCallback?.(this.iframe);
            }

            handleError(error) {
                this.clearTimeout();
                this.onErrorCallback?.(error);
            }

            clearTimeout() {
                if (this.timeoutId) {
                    clearTimeout(this.timeoutId);
                    this.timeoutId = null;
                }
            }

            onLoad(callback) {
                this.onLoadCallback = callback;
                return this;
            }

            onError(callback) {
                this.onErrorCallback = callback;
                return this;
            }

            destroy() {
                this.clearTimeout();
                this.iframe?.parentNode?.removeChild(this.iframe);
                this.iframe = null;
                this.onLoadCallback = null;
                this.onErrorCallback = null;
            }
        }

        // Initialisation
        const core = new Core();
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => core.init());
        } else {
            core.init();
        }
    </script>
</body>
</html>