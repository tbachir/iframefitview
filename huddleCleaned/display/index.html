<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>HuddleBoard Display</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }

        .display-header {
            position: fixed;
            top: 0;
            left: 0;
            padding: 10px 15px;
            z-index: 1000;
            display: flex;
            align-items: center;
            background: #dc2626;
            color: white;
            text-transform: uppercase;
        }

        .back-button {
            color: white;
            margin-right: 10px;
            text-decoration: none;
        }

        .iframe-container {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 100vw;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .iframe-container iframe {
            border: none;
            background: transparent;
            transform-origin: 0 0;
        }

        .banner {
            position: absolute;
            background: rgba(220, 38, 38, 0.82);
            color: #fff;
            z-index: 1000;
            border-radius: 5px;
            font-size: 1em;
            padding: 4px 10px;
        }

        .modif-banner {
            right: 10px;
            bottom: 10px;
        }

        .status-banner {
            right: 10px;
            top: 10px;
        }

        .status-indicator {
            display: inline-block;
            width: 11px;
            height: 11px;
            border-radius: 50%;
            margin-left: 6px;
            background: #10b981;
            border: 1.5px solid #fff2;
        }

        .status-fail {
            background: #dc2626;
        }
    </style>
</head>

<body>
    <div id="app"></div>

    <script src="../config.js"></script>
    <script>
        class Core {
            constructor() {
                this.display = null;
            }
            init() {
                // Validation config minimale
                if (!window.AppConfig?.displays) {
                    document.getElementById('app').innerHTML = `
                        <div style="padding: 50px; text-align: center; font-family: Arial;">
                            <h2>Configuration manquante</h2>
                            <a href="../" style="color: #dc2626;">← Retour</a>
                        </div>
                    `;
                    return;
                }

                const hash = window.location.hash;
                const slug = hash?.startsWith('#/') ? hash.substring(2) : null;
                this.display = window.AppConfig.displays.find(d => d?.slug === slug);

                if (this.display) {
                    const displayManager = new DisplayManager(this.display);
                    displayManager.render();
                }
            }
        }

        function getOrCreateBanner(id, classes) {
            let el = document.getElementById(id);
            if (!el) {
                el = document.createElement('div');
                el.id = id;
                el.className = classes;
                document.body.appendChild(el);
            }
            return el;
        }

        function formatTime(date) {
            return date
                ? date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                : '—';
        }

        function showModifBanner(date = new Date()) {
            getOrCreateBanner('modif-banner', 'banner modif-banner').textContent =
                `Modifié à ${formatTime(date)}`;
        }

        function showStatusBanner(date, ok = true) {
            showStatusBanner.lastDate = ok && date ? date : showStatusBanner.lastDate;
            const el = getOrCreateBanner('status-banner', 'banner status-banner');
            el.innerHTML = `${formatTime(showStatusBanner.lastDate)}<span class="status-indicator${ok ? '' : ' status-fail'}"></span>`;
        }

        class DisplayManager {
            constructor(display) {
                this.display = display;
                this.iframe = null;
            }

            render() {
                document.getElementById('app').innerHTML = `
                    <div class="display-header">
                        <a href="../" class="back-button">←</a>
                        <h3 style="margin: 0;">${this.display.name}</h3>
                    </div>
                    <div class="iframe-container">
                        <iframe src="${this.display.path}" id="display-iframe"></iframe>
                    </div>
                `;

                this.iframe = document.getElementById('display-iframe');

                // Initialiser les services
                new ScaleHandler(this.iframe);
                new RefreshService(this.display, this.iframe);
            }
        }

        class ScaleHandler {
            constructor(iframe) {
                this.iframe = iframe;
                this.contentW = window.innerWidth;
                this.contentH = window.innerHeight;

                this.init();
            }

            init() {
                this.iframe.addEventListener('load', () => {
                    setTimeout(() => this.onLoad(), 150);
                });
                window.addEventListener('resize', () => this.applyScale());
            }

            onLoad() {
                const doc = this.iframe.contentDocument;
                if (!doc) return;

                // Masquer les scrollbars et mesurer le contenu
                doc.head.appendChild(Object.assign(doc.createElement('style'), {
                    textContent: 'html, body { overflow: hidden !important; margin: 0; padding: 0; }'
                }));

                this.contentW = Math.max(
                    doc.documentElement.scrollWidth,
                    doc.documentElement.offsetWidth,
                    doc.body.scrollWidth,
                    doc.body.offsetWidth,
                    1
                );

                this.contentH = Math.max(
                    doc.documentElement.scrollHeight,
                    doc.documentElement.offsetHeight,
                    doc.body.scrollHeight,
                    doc.body.offsetHeight,
                    1
                );

                this.applyScale();
            }

            applyScale() {
                const containerW = window.innerWidth;
                const containerH = window.innerHeight;
                const scale = Math.min(containerW / this.contentW, containerH / this.contentH);

                Object.assign(this.iframe.style, {
                    width: `${this.contentW}px`,
                    height: `${this.contentH}px`,
                    transform: `scale(${scale})`,
                    left: `${(containerW - this.contentW * scale) / 2}px`,
                    top: `${(containerH - this.contentH * scale) / 2}px`,
                    position: 'absolute'
                });
            }
        }

        class RefreshService {
            constructor(display, iframe) {
                this.display = display;
                this.iframe = iframe;
                this.interval = display.refreshInterval || window.AppConfig?.defaultRefreshInterval || 30000;
                this.timer = null;
                this.lastHash = null;
                this.start();
            }

            calculateHash(text) {
                if (typeof text !== 'string') return '0';
                let hash = 5381;
                for (let i = 0; i < text.length; i++) {
                    hash = ((hash << 5) + hash) ^ text.charCodeAt(i);
                }
                return (hash >>> 0).toString(16);
            }

            start() {
                this.refresh();
                this.timer = setInterval(() => this.refresh(), this.interval);
            }

            async refresh() {
                const preloadUrl = this.buildUrl();
                const now = new Date();
                try {
                    const response = await fetch(preloadUrl, { method: 'GET', cache: 'no-cache' });
                    if (!response.ok) {
                        showStatusBanner(undefined, false);
                        return;
                    }
                    showStatusBanner(now, true);
                    const newContent = await response.text();
                    if (!newContent) return;
                    const newHash = this.calculateHash(newContent);
                    if (!this.lastHash) {
                        this.lastHash = newHash;
                        return;
                    }
                    if (newHash !== this.lastHash) {
                        this.lastHash = newHash;
                        this.iframe.src = preloadUrl;
                        showModifBanner(now);
                    }
                } catch (error) {
                    showStatusBanner(undefined, false);
                }
            }

            buildUrl() {
                const base = this.display.path;
                const separator = base.includes('?') ? '&' : '?';
                return `${base}${separator}t=${Date.now()}`;
            }
        }

        // Initialisation
        const core = new Core();
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => core.init());
        } else {
            core.init();
        }
    </script>
</body>

</html>